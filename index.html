<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Plant Health Checker</title>
    <!-- EMBEDDED TAILWIND CSS (Offline!) - Minified from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* EMBEDDED GOOGLE FONTS ALTERNATIVE: Use system fonts for offline */
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: #f7fdee;
        }
        /* Rest of custom styles (unchanged) */
        .card {
            box-shadow: 0 10px 30px rgba(139, 172, 139, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(139, 172, 139, 0.3);
        }
        #upload-box {
            border: 3px dashed #8baf8b;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        #upload-box:hover {
            background-color: #f0f7f0;
        }
        .focus-ring {
            box-shadow: 0 0 0 3px rgba(139, 172, 139, 0.5);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #camera-modal {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 50;
        }
        #video {
            width: 100%;
            max-width: 640px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <!-- Auth Section -->
    <div id="auth-section" class="w-full max-w-md bg-white rounded-xl card p-6 md:p-10">
        <!-- Login Form -->
        <div id="login-form-container">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-green-800 mb-2">
                    Plant Doctor AI üåø
                </h1>
                <p class="text-lg text-gray-500">
                    Please login to access the plant health checker.
                </p>
            </header>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-username" class="block text-gray-700 font-semibold mb-2">Username</label>
                    <input type="text" id="login-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-700 font-semibold mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-200 focus:outline-none focus-ring">
                    Login
                </button>
            </form>
            <p class="text-center mt-4">Don't have an account? <a href="#" id="switch-to-signup" class="text-green-600 hover:underline">Sign up</a></p>
            <p id="login-error" class="text-red-600 mt-4 text-center hidden">Invalid username or password. Please try again.</p>
        </div>

        <!-- Signup Form (Hidden Initially) -->
        <div id="signup-form-container" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-green-800 mb-2">
                    Plant Doctor AI üåø
                </h1>
                <p class="text-lg text-gray-500">
                    Create an account to access the plant health checker.
                </p>
            </header>
            <form id="signup-form" class="space-y-4">
                <div>
                    <label for="signup-username" class="block text-gray-700 font-semibold mb-2">Username</label>
                    <input type="text" id="signup-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-gray-700 font-semibold mb-2">Password</label>
                    <input type="password" id="signup-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-200 focus:outline-none focus-ring">
                    Sign Up
                </button>
            </form>
            <p class="text-center mt-4">Already have an account? <a href="#" id="switch-to-login" class="text-green-600 hover:underline">Login</a></p>
            <p id="signup-error" class="text-red-600 mt-4 text-center hidden">Username already exists or invalid input.</p>
            <p id="signup-success" class="text-green-600 mt-4 text-center hidden">Account created successfully! Please login.</p>
        </div>
    </div>

    <!-- Main Section (Hidden Initially) -->
    <div id="main-section" class="hidden w-full max-w-4xl bg-white rounded-xl card p-6 md:p-10">
        <header class="text-center mb-8 flex justify-between items-center">
            <h1 class="text-4xl font-bold text-green-800 mb-2">
                Plant Doctor AI üåø
            </h1>
            <button id="logout-button" class="bg-red-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-700 transition duration-200 focus:outline-none focus-ring">
                Logout
            </button>
        </header>
        <p class="text-lg text-gray-500 text-center mb-8">
            Upload a leaf image to get an instant diagnosis and treatment plan.
        </p>
        <div id="upload-section">
            <div id="upload-box" onclick="triggerFileUpload()" class="flex flex-col items-center justify-center h-48 rounded-lg p-6 text-gray-600 hover:text-green-700 mb-4">
                <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5-8l-2-2m0 0L7 8m2-2v4"></path></svg>
                <p class="font-semibold text-lg">Click or Drag & Drop your Plant Leaf Image</p>
                <p class="text-sm text-gray-400">JPEG, PNG, or GIF up to 5MB</p>
            </div>
            <button id="use-camera" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-200 focus:outline-none focus-ring">
                Take Photo from Camera
            </button>
            <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileChange(event)">
        </div>
        <div id="preview-section" class="hidden mt-6 p-4 border border-gray-200 rounded-lg">
            <h2 class="text-xl font-semibold text-green-700 mb-4">Diagnosis Status</h2>
            <div class="md:flex md:space-x-6">
                <div class="mb-4 md:mb-0 md:w-1/3">
                    <p class="text-gray-500 mb-2">Uploaded Image:</p>
                    <img id="image-preview" class="w-full h-auto object-cover rounded-lg shadow-md" alt="Plant Leaf Preview">
                </div>
               
                <div class="md:w-2/3 flex flex-col justify-between">
                    <div id="status-message" class="text-gray-700 text-base mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
                        Please upload an image to start the analysis.
                    </div>
                    <button id="diagnose-button" onclick="startDiagnosis()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-200 focus:outline-none focus-ring disabled:opacity-50" disabled>
                        Start AI Diagnosis (Needs Internet)
                    </button>
                    <button id="reset-button" onclick="resetApp()" class="w-full mt-2 bg-gray-300 text-gray-800 py-3 rounded-lg font-bold hover:bg-gray-400 transition duration-200 focus:outline-none focus-ring">
                        Reset
                    </button>
                </div>
            </div>
        </div>
        <div id="result-section" class="hidden mt-8">
            <h2 class="text-3xl font-bold text-red-600 mb-6 border-b pb-2">
                <span id="diagnosis-emoji">ü¶†</span> Diagnosis Result
            </h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                    <h3 class="text-xl font-semibold text-red-700 mb-3">Identified Issue:</h3>
                    <p id="result-diagnosis" class="text-2xl font-extrabold text-red-800"></p>
                    <p id="result-plant-type" class="text-gray-600 mt-1"></p>
                </div>
                <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                    <h3 class="text-xl font-semibold text-green-700 mb-3">AI Confidence:</h3>
                    <p id="result-confidence" class="text-2xl font-extrabold text-green-800"></p>
                </div>
            </div>
            <div class="mt-6 bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                <h3 class="text-2xl font-bold text-green-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.204A9.954 9.954 0 0012 3c-4.419 0-8.24 1.803-10.618 4.796m14.236 0c.2.469.366.97.485 1.504M20 10.5c0 .324.015.645.044.966M12 21c-2.41 0-4.63-.642-6.556-1.754M17.152 14.848l-1.424-1.424m-1.424-1.424l-1.424-1.424"></path></svg>
                    Recommended Treatment Plan
                </h3>
                <p id="result-treatment" class="text-gray-700 whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <!-- Camera Modal (Hidden Initially) -->
    <div id="camera-modal" class="hidden fixed inset-0 flex items-center justify-center">
        <div class="bg-white p-4 rounded-lg shadow-lg">
            <video id="video" autoplay playsinline></video>
            <div class="mt-4 flex justify-between">
                <button id="capture-button" class="bg-green-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-700">Capture</button>
                <button id="close-camera" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-700">Close</button>
            </div>
        </div>
    </div>

    <script>
        // User storage (using localStorage for demo; not secure for real apps)
        function getUsers() {
            return JSON.parse(localStorage.getItem('users')) || [];
        }

        function saveUsers(users) {
            localStorage.setItem('users', JSON.stringify(users));
        }

        // Switch between login and signup
        const switchToSignup = document.getElementById('switch-to-signup');
        const switchToLogin = document.getElementById('switch-to-login');
        const loginFormContainer = document.getElementById('login-form-container');
        const signupFormContainer = document.getElementById('signup-form-container');

        switchToSignup.addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer.classList.add('hidden');
            signupFormContainer.classList.remove('hidden');
        });

        switchToLogin.addEventListener('click', (e) => {
            e.preventDefault();
            signupFormContainer.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
        });

        // Signup handling
        const signupForm = document.getElementById('signup-form');
        const signupError = document.getElementById('signup-error');
        const signupSuccess = document.getElementById('signup-success');

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value.trim();

            if (!username || !password) {
                signupError.textContent = 'Please enter both username and password.';
                signupError.classList.remove('hidden');
                signupSuccess.classList.add('hidden');
                return;
            }

            let users = getUsers();
            if (users.some(user => user.username === username)) {
                signupError.textContent = 'Username already exists.';
                signupError.classList.remove('hidden');
                signupSuccess.classList.add('hidden');
                return;
            }

            users.push({ username, password });
            saveUsers(users);

            signupError.classList.add('hidden');
            signupSuccess.classList.remove('hidden');

            // Reset form
            document.getElementById('signup-username').value = '';
            document.getElementById('signup-password').value = '';

            // Switch to login after success
            setTimeout(() => {
                signupFormContainer.classList.add('hidden');
                loginFormContainer.classList.remove('hidden');
                signupSuccess.classList.add('hidden');
            }, 2000);
        });

        // Login handling
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const authSection = document.getElementById('auth-section');
        const mainSection = document.getElementById('main-section');

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                authSection.classList.add('hidden');
                mainSection.classList.remove('hidden');
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // Logout handling
        const logoutButton = document.getElementById('logout-button');
        logoutButton.addEventListener('click', () => {
            mainSection.classList.add('hidden');
            authSection.classList.remove('hidden');
            loginFormContainer.classList.remove('hidden');
            signupFormContainer.classList.add('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            loginError.classList.add('hidden');
            resetApp();
        });

        // Camera handling
        const useCamera = document.getElementById('use-camera');
        const cameraModal = document.getElementById('camera-modal');
        const video = document.getElementById('video');
        const captureButton = document.getElementById('capture-button');
        const closeCamera = document.getElementById('close-camera');

        useCamera.addEventListener('click', () => {
            cameraModal.classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => {
                    console.error('Error accessing camera:', err);
                    alert('Could not access camera. Please check permissions.');
                    cameraModal.classList.add('hidden');
                });
        });

        captureButton.addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => {
                const file = new File([blob], 'camera_photo.jpg', { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                uploadInput.files = dataTransfer.files;
                handleFileChange({ target: { files: uploadInput.files } });
                cameraModal.classList.add('hidden');
                video.srcObject.getTracks().forEach(track => track.stop());
            }, 'image/jpeg');
        });

        closeCamera.addEventListener('click', () => {
            cameraModal.classList.add('hidden');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });

        // SAME JAVASCRIPT AS BEFORE (API still needs internet)
        const apiKey = "AIzaSyDgcYJ9YCcEmkIpwhpanXKIwO3ymVNYa4g";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
       
        let uploadedFileBase64 = null;
        const uploadInput = document.getElementById('file-upload');
        const uploadBox = document.getElementById('upload-box');
        const previewSection = document.getElementById('preview-section');
        const resultSection = document.getElementById('result-section');
        const diagnoseButton = document.getElementById('diagnose-button');
        const imagePreview = document.getElementById('image-preview');
        const statusMessage = document.getElementById('status-message');
        // [Rest of the JS functions unchanged: fileToBase64, triggerFileUpload, handleFileChange, resetApp, setLoading, startDiagnosis, displayResults, Drag & Drop]
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        function triggerFileUpload() {
            uploadInput.click();
        }
        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                statusMessage.innerHTML = 'File too large. Max size is 5MB. Please choose a smaller image.';
                statusMessage.classList.remove('bg-blue-50');
                statusMessage.classList.add('bg-red-50', 'border-red-400');
                uploadInput.value = '';
                return;
            }
            fileToBase64(file).then(base64Data => {
                uploadedFileBase64 = base64Data;
                imagePreview.src = URL.createObjectURL(file);
               
                document.getElementById('upload-section').classList.add('hidden');
                previewSection.classList.remove('hidden');
                resultSection.classList.add('hidden');
               
                statusMessage.innerHTML = 'Image uploaded successfully. Ready for AI diagnosis (connect to internet to proceed).';
                statusMessage.classList.remove('bg-yellow-50', 'border-yellow-400', 'bg-red-50', 'border-red-400');
                statusMessage.classList.add('bg-blue-50', 'border-blue-400');
                diagnoseButton.disabled = false;
                diagnoseButton.innerHTML = 'Start AI Diagnosis (Needs Internet)';
            }).catch(error => {
                console.error("File processing error:", error);
                statusMessage.innerHTML = 'Could not process file. Check console for details.';
                statusMessage.classList.remove('bg-blue-50');
                statusMessage.classList.add('bg-red-50', 'border-red-400');
            });
        }
        function resetApp() {
            uploadedFileBase64 = null;
            uploadInput.value = '';
            diagnoseButton.disabled = true;
           
            document.getElementById('upload-section').classList.remove('hidden');
            previewSection.classList.add('hidden');
            resultSection.classList.add('hidden');
           
            statusMessage.innerHTML = 'Please upload an image to start the analysis.';
            statusMessage.classList.remove('bg-blue-50', 'border-blue-400', 'bg-red-50', 'border-red-400', 'bg-green-50', 'border-green-400');
            statusMessage.classList.add('bg-yellow-50', 'border-yellow-400');
            document.getElementById('diagnosis-emoji').textContent = 'ü¶†';
        }
        function setLoading(isLoading) {
            diagnoseButton.disabled = isLoading;
            if (isLoading) {
                diagnoseButton.innerHTML = `
                    <div class="loader"></div>
                    Analyzing...
                `;
                statusMessage.innerHTML = 'Sending image to AI for deep analysis... This may take a moment.';
                statusMessage.classList.remove('bg-blue-50', 'border-blue-400');
                statusMessage.classList.add('bg-yellow-50', 'border-yellow-400');
            } else {
                diagnoseButton.innerHTML = 'Start AI Diagnosis (Needs Internet)';
            }
        }
        async function startDiagnosis() {
            if (!uploadedFileBase64) return;
           
            setLoading(true);
           
            // Offline warning if no connection (simple check)
            if (!navigator.onLine) {
                setLoading(false);
                statusMessage.innerHTML = 'No internet connection detected. Diagnosis requires online access to AI.';
                statusMessage.classList.add('bg-red-50', 'border-red-400');
                return;
            }
           
            const systemPrompt = `You are a world-class plant pathologist and agricultural expert. Analyze the provided image of the plant leaf.
            1. Identify the Plant Type (e.g., Tomato, Apple, Corn).
            2. Identify the Disease (or state 'Healthy' if no disease is present).
            3. Provide a detailed Treatment Plan (for disease) or Care Plan (for healthy) in 3-5 concise, actionable steps.
            4. Output ONLY a single JSON object that strictly follows the provided schema. Do not add any extra text or markdown outside the JSON block.`;
            const userQuery = "Analyze this plant leaf image. Identify the plant, the health status, and provide the appropriate care/treatment plan.";
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "plantType": { "type": "STRING" },
                    "diseaseName": { "type": "STRING" },
                    "confidenceScore": { "type": "NUMBER" },
                    "treatmentPlan": { "type": "STRING" }
                },
                required: ["plantType", "diseaseName", "confidenceScore", "treatmentPlan"]
            };
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: uploadInput.files[0].type || "image/jpeg",
                                    data: uploadedFileBase64
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("No response from AI");
                    const responseData = JSON.parse(text);
                    setLoading(false);
                    displayResults(responseData);
                    return;
                } catch (error) {
                    console.error("API Error:", error);
                    if (attempt === maxRetries - 1) {
                        statusMessage.innerHTML = `Diagnosis failed. Error: ${error.message}. Try again later or check connection.`;
                        statusMessage.classList.remove('bg-yellow-50', 'border-yellow-400');
                        statusMessage.classList.add('bg-red-50', 'border-red-400');
                    }
                }
            }
            setLoading(false);
        }
        function displayResults(data) {
            if (!data) return;
            const isHealthy = data.diseaseName.toLowerCase() === 'healthy';
            const confidence = (data.confidenceScore * 100).toFixed(1);
            const emoji = isHealthy ? 'üå±' : '‚ö†Ô∏è';
            document.getElementById('diagnosis-emoji').textContent = emoji;
            document.getElementById('result-diagnosis').textContent = data.diseaseName;
            document.getElementById('result-plant-type').textContent = `Plant Type: ${data.plantType}`;
            document.getElementById('result-confidence').textContent = `${confidence}%`;
            document.getElementById('result-treatment').textContent = data.treatmentPlan;
           
            statusMessage.innerHTML = `Diagnosis complete! Result: <strong>${data.diseaseName}</strong>`;
            statusMessage.className = `text-gray-700 text-base mb-4 p-3 rounded ${isHealthy ? 'bg-green-50 border-l-4 border-green-400' : 'bg-red-50 border-l-4 border-red-400'}`;
            resultSection.classList.remove('hidden');
            const diagnosisCard = document.querySelector('#result-section .grid > div:nth-child(1)');
            const header = document.querySelector('#result-section h2');
            if (isHealthy) {
                diagnosisCard.classList.replace('bg-red-50', 'bg-green-50');
                diagnosisCard.classList.replace('border-red-200', 'border-green-200');
                header.classList.replace('text-red-600', 'text-green-600');
            } else {
                diagnosisCard.classList.replace('bg-green-50', 'bg-red-50');
                diagnosisCard.classList.replace('border-green-200', 'border-red-200');
                header.classList.replace('text-green-600', 'text-red-600');
            }
        }
        // Drag & Drop
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('focus-ring');
        });
        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('focus-ring');
        });
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('focus-ring');
            if (e.dataTransfer.files.length) {
                uploadInput.files = e.dataTransfer.files;
                uploadInput.dispatchEvent(new Event('change'));
            }
        });
        console.log("Plant Doctor AI Loaded! Upload a leaf image to begin (AI needs internet).");
    </script>
</body>
</html>
