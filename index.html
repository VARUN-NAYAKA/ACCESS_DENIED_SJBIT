<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Plant Health Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {font-family:system-ui,-apple-system,sans-serif;background:#121212;color:#e5e5e5;}
        .card{box-shadow:0 10px 30px rgba(0,0,0,.5);transition:transform .3s,box-shadow .3s;background:#1f2937;}
        .card:hover{transform:translateY(-2px);box-shadow:0 15px 40px rgba(0,0,0,.6);}
        #upload-box{border:3px dashed #4b5563;transition:background .2s;cursor:pointer;}
        #upload-box:hover{background:#374151;}
        .focus-ring{box-shadow:0 0 0 3px rgba(75,85,99,.5);}
        .loader{border:4px solid #4b5563;border-top:4px solid #10b981;border-radius:50%;width:24px;height:24px;display:inline-block;animation:spin 1s linear infinite;margin-right:.5rem;}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #camera-modal{background:rgba(0,0,0,.8);z-index:50;}
        #video{width:100%;max-width:640px;}
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6 md:p-8">

    <!-- Auth Section -->
    <div id="auth-section" class="w-full max-w-md bg-gray-800 rounded-xl card p-8 md:p-12">
        <div id="login-form-container">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold text-green-300 mb-3">Plant Doctor AI</h1>
                <p class="text-lg text-gray-400">Please login to access the plant health checker.</p>
            </header>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-username" class="block text-gray-300 font-semibold mb-2">Username</label>
                    <input type="text" id="login-username" class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:border-green-500 bg-gray-700 text-gray-100" required>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-300 font-semibold mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:border-green-500 bg-gray-700 text-gray-100" required>
                </div>
                <button type="submit" class="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition duration-200 focus:outline-none focus-ring">Login</button>
            </form>
            <p class="text-center mt-6 text-gray-400">Don't have an account? <a href="#" id="switch-to-signup" class="text-green-500 hover:underline">Sign up</a></p>
            <p id="login-error" class="text-red-500 mt-6 text-center hidden">Invalid username or password. Please try again.</p>
        </div>

        <div id="signup-form-container" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold text-green-300 mb-3">Plant Doctor AI</h1>
                <p class="text-lg text-gray-400">Create an account to access the plant health checker.</p>
            </header>
            <form id="signup-form" class="space-y-6">
                <div>
                    <label for="signup-username" class="block text-gray-300 font-semibold mb-2">Username</label>
                    <input type="text" id="signup-username" class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:border-green-500 bg-gray-700 text-gray-100" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-gray-300 font-semibold mb-2">Password</label>
                    <input type="password" id="signup-password" class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:border-green-500 bg-gray-700 text-gray-100" required>
                </div>
                <button type="submit" class="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition duration-200 focus:outline-none focus-ring">Sign Up</button>
            </form>
            <p class="text-center mt-6 text-gray-400">Already have an account? <a href="#" id="switch-to-login" class="text-green-500 hover:underline">Login</a></p>
            <p id="signup-error" class="text-red-500 mt-6 text-center hidden">Username already exists or invalid input.</p>
            <p id="signup-success" class="text-green-500 mt-6 text-center hidden">Account created successfully! Please login.</p>
        </div>
    </div>

    <!-- Main Section -->
    <div id="main-section" class="hidden w-full max-w-4xl bg-gray-800 rounded-xl card p-8 md:p-12">
        <header class="text-center mb-10 flex justify-between items-center">
            <h1 class="text-4xl font-bold text-green-300 mb-3">Plant Doctor AI</h1>
            <div class="flex gap-3">
                <button id="lang-toggle" class="bg-indigo-700 text-white py-2 px-5 rounded-lg font-bold hover:bg-indigo-800 transition duration-200 focus:outline-none focus-ring">‡≤ï‡≤®‡≥ç‡≤®‡≤°</button>
                <button id="logout-button" class="bg-red-700 text-white py-2 px-5 rounded-lg font-bold hover:bg-red-800 transition duration-200 focus:outline-none focus-ring">Logout</button>
            </div>
        </header>
        <p class="text-lg text-gray-400 text-center mb-10">Upload a leaf image to get an instant diagnosis and treatment plan.</p>
        <div id="upload-section">
            <div id="upload-box" onclick="triggerFileUpload()" class="flex flex-col items-center justify-center h-52 rounded-lg p-8 text-gray-400 hover:text-green-300 mb-6 border-3 border-dashed border-gray-600">
                <svg class="w-14 h-14 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5-8l-2-2m0 0L7 8m2-2v4"></path></svg>
                <p class="font-semibold text-xl">Click or Drag & Drop your Plant Leaf Image</p>
                <p class="text-sm text-gray-500 mt-2">JPEG, PNG, or GIF up to 5MB</p>
            </div>
            <button id="use-camera" class="w-full bg-blue-700 text-white py-3 rounded-lg font-bold hover:bg-blue-800 transition duration-200 focus:outline-none focus-ring">Take Photo from Camera</button>
            <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileChange(event)">
        </div>
        <div id="preview-section" class="hidden mt-10 p-6 border border-gray-600 rounded-lg">
            <h2 class="text-xl font-semibold text-green-300 mb-6">Diagnosis Status</h2>
            <div class="md:flex md:space-x-8">
                <div class="mb-6 md:mb-0 md:w-1/3">
                    <p class="text-gray-400 mb-3">Uploaded Image:</p>
                    <img id="image-preview" class="w-full h-auto object-cover rounded-lg shadow-md" alt="Plant Leaf Preview">
                </div>
                <div class="md:w-2/3 flex flex-col justify-between">
                    <div id="status-message" class="text-gray-300 text-base mb-6 bg-yellow-900 border-l-4 border-yellow-600 p-4 rounded">Please upload an image to start the analysis.</div>
                    <button id="diagnose-button" onclick="startDiagnosis()" class="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition duration-200 focus:outline-none focus-ring disabled:opacity-50" disabled>Start AI Diagnosis (Needs Internet)</button>
                    <button id="reset-button" onclick="resetApp()" class="w-full mt-4 bg-gray-600 text-gray-300 py-3 rounded-lg font-bold hover:bg-gray-500 transition duration-200 focus:outline-none focus-ring">Reset</button>
                </div>
            </div>
        </div>
        <div id="result-section" class="hidden mt-10">
            <h2 class="text-3xl font-bold text-red-300 mb-8 border-b pb-3"><span id="diagnosis-emoji">Warning</span> Diagnosis Result</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-red-900 p-8 rounded-xl border border-red-700">
                    <h3 class="text-xl font-semibold text-red-300 mb-4">Identified Issue:</h3>
                    <p id="result-diagnosis" class="text-2xl font-extrabold text-red-200"></p>
                    <p id="result-plant-type" class="text-gray-400 mt-2"></p>
                </div>
                <div class="bg-green-900 p-8 rounded-xl border border-green-700">
                    <h3 class="text-xl font-semibold text-green-300 mb-4">AI Confidence:</h3>
                    <p id="result-confidence" class="text-2xl font-extrabold text-green-200"></p>
                </div>
            </div>
            <div class="mt-8 bg-gray-700 p-8 rounded-xl border border-gray-600 shadow-lg">
                <h3 class="text-2xl font-bold text-green-300 mb-5 flex items-center">
                    <svg class="w-7 h-7 mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.204A9.954 9.954 0 0012 3c-4.419 0-8.24 1.803-10.618 4.796m14.236 0c.2.469.366.97.485 1.504M20 10.5c0 .324.015.645.044.966M12 21c-2.41 0-4.63-.642-6.556-1.754M17.152 14.848l-1.424-1.424m-1.424-1.424l-1.424-1.424"></path></svg>
                    Recommended Treatment Plan
                </h3>
                <p id="result-treatment" class="text-gray-300 whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <video id="video" autoplay playsinline></video>
            <div class="mt-6 flex justify-between">
                <button id="capture-button" class="bg-green-700 text-white py-3 px-6 rounded-lg font-bold hover:bg-green-800">Capture</button>
                <button id="close-camera" class="bg-gray-600 text-white py-3 px-6 rounded-lg font-bold hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>

    <script>
        /* ----------  LANGUAGE DICTIONARY ---------- */
        const translations = {
            en: {
                title: "Plant Doctor AI",
                subtitle: "Upload a leaf image to get an instant diagnosis and treatment plan.",
                uploadBox: "Click or Drag & Drop your Plant Leaf Image",
                uploadHint: "JPEG, PNG, or GIF up to 5MB",
                cameraBtn: "Take Photo from Camera",
                diagnoseBtn: "Start AI Diagnosis (Needs Internet)",
                resetBtn: "Reset",
                diagnosisStatus: "Diagnosis Status",
                uploadedImage: "Uploaded Image:",
                readyMsg: "Image uploaded successfully. Ready for AI diagnosis (connect to internet to proceed).",
                analyzingMsg: "Sending image to AI for deep analysis... This may take a moment.",
                noInternet: "No internet connection detected. Diagnosis requires online access to AI.",
                resultHeader: "Diagnosis Result",
                identifiedIssue: "Identified Issue:",
                confidence: "AI Confidence:",
                treatmentHeader: "Recommended Treatment Plan",
                loginHeader: "Plant Doctor AI",
                loginSub: "Please login to access the plant health checker.",
                username: "Username",
                password: "Password",
                loginBtn: "Login",
                noAccount: "Don't have an account? <a href='#' id='switch-to-signup' class='text-green-500 hover:underline'>Sign up</a>",
                signupHeader: "Plant Doctor AI",
                signupSub: "Create an account to access the plant health checker.",
                signupBtn: "Sign Up",
                haveAccount: "Already have an account? <a href='#' id='switch-to-login' class='text-green-500 hover:underline'>Login</a>",
                logoutBtn: "Logout"
            },
            kn: {
                title: "‡≤™‡≥ç‡≤≤‡≤æ‡≤Ç‡≤ü‡≥ç ‡≤°‡≤æ‡≤ï‡≥ç‡≤ü‡≤∞‡≥ç AI",
                subtitle: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤é‡≤≤‡≥Ü‡≤Ø ‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ö‡≤™‡≥ç‚Äå‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø, ‡≤§‡≤ï‡≥ç‡≤∑‡≤£ ‡≤∞‡≥ã‡≤ó‡≤®‡≤ø‡≤∞‡≥ç‡≤£‡≤Ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤ö‡≤ø‡≤ï‡≤ø‡≤§‡≥ç‡≤∏‡≤æ ‡≤Ø‡≥ã‡≤ú‡≤®‡≥Ü ‡≤™‡≤°‡≥Ü‡≤Ø‡≤ø‡≤∞‡≤ø.",
                uploadBox: "‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∏‡≤∏‡≥ç‡≤Ø‡≤¶ ‡≤é‡≤≤‡≥Ü‡≤Ø ‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤ï‡≥ç‡≤≤‡≤ø‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤°‡≥ç‡≤∞‡≥ç‡≤Ø‡≤æ‡≤ó‡≥ç & ‡≤°‡≥ç‡≤∞‡≤æ‡≤™‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø",
                uploadHint: "JPEG, PNG, ‡≤Ö‡≤•‡≤µ‡≤æ GIF 5MB ‡≤µ‡≤∞‡≥Ü‡≤ó‡≥Ü",
                cameraBtn: "‡≤ï‡≥ç‡≤Ø‡≤æ‡≤Æ‡≥Ü‡≤∞‡≤æ‡≤¶‡≤ø‡≤Ç‡≤¶ ‡≤´‡≥ã‡≤ü‡≥ã ‡≤§‡≥Ü‡≤ó‡≥Ü‡≤¶‡≥Å‡≤ï‡≥ä‡≤≥‡≥ç‡≤≥‡≤ø",
                diagnoseBtn: "AI ‡≤∞‡≥ã‡≤ó‡≤®‡≤ø‡≤∞‡≥ç‡≤£‡≤Ø ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤ø‡≤∏‡≤ø (‡≤á‡≤Ç‡≤ü‡≤∞‡≥ç‡≤®‡≥Ü‡≤ü‡≥ç ‡≤Ö‡≤ó‡≤§‡≥ç‡≤Ø)",
                resetBtn: "‡≤Æ‡≤∞‡≥Å‡≤π‡≥ä‡≤Ç‡≤¶‡≤ø‡≤∏‡≤ø",
                diagnosisStatus: "‡≤∞‡≥ã‡≤ó‡≤®‡≤ø‡≤∞‡≥ç‡≤£‡≤Ø ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø",
                uploadedImage: "‡≤Ö‡≤™‡≥ç‚Äå‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø‡≤¶ ‡≤ö‡≤ø‡≤§‡≥ç‡≤∞:",
                readyMsg: "‡≤ö‡≤ø‡≤§‡≥ç‡≤∞ ‡≤Ø‡≤∂‡≤∏‡≥ç‡≤µ‡≤ø‡≤Ø‡≤æ‡≤ó‡≤ø ‡≤Ö‡≤™‡≥ç‚Äå‡≤≤‡≥ã‡≤°‡≥ç ‡≤Ü‡≤Ø‡≤ø‡≤§‡≥Å. AI ‡≤∞‡≥ã‡≤ó‡≤®‡≤ø‡≤∞‡≥ç‡≤£‡≤Ø‡≤ï‡≥ç‡≤ï‡≥Ü ‡≤∏‡≤ø‡≤¶‡≥ç‡≤ß (‡≤á‡≤Ç‡≤ü‡≤∞‡≥ç‡≤®‡≥Ü‡≤ü‡≥ç‚Äå‡≤ó‡≥Ü ‡≤∏‡≤Ç‡≤™‡≤∞‡≥ç‡≤ï‡≤ø‡≤∏‡≤ø).",
                analyzingMsg: "‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å AI ‡≤ó‡≥Ü ‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü... ‡≤∏‡≥ç‡≤µ‡≤≤‡≥ç‡≤™ ‡≤∏‡≤Æ‡≤Ø ‡≤§‡≥Ü‡≤ó‡≥Ü‡≤¶‡≥Å‡≤ï‡≥ä‡≤≥‡≥ç‡≤≥‡≤¨‡≤π‡≥Å‡≤¶‡≥Å.",
                noInternet: "‡≤á‡≤Ç‡≤ü‡≤∞‡≥ç‡≤®‡≥Ü‡≤ü‡≥ç ‡≤∏‡≤Ç‡≤™‡≤∞‡≥ç‡≤ï ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤∞‡≥ã‡≤ó‡≤®‡≤ø‡≤∞‡≥ç‡≤£‡≤Ø‡≤ï‡≥ç‡≤ï‡≥Ü ‡≤Ü‡≤®‡≥ç‚Äå‡≤≤‡≥à‡≤®‡≥ç ‡≤™‡≥ç‡≤∞‡≤µ‡≥á‡≤∂ ‡≤Ö‡≤ó‡≤§‡≥ç‡≤Ø.",
                resultHeader: "‡≤∞‡≥ã‡≤ó‡≤®‡≤ø‡≤∞‡≥ç‡≤£‡≤Ø ‡≤´‡≤≤‡≤ø‡≤§‡≤æ‡≤Ç‡≤∂",
                identifiedIssue: "‡≤ó‡≥Å‡≤∞‡≥Å‡≤§‡≤ø‡≤∏‡≤≤‡≤æ‡≤¶ ‡≤∏‡≤Æ‡≤∏‡≥ç‡≤Ø‡≥Ü:",
                confidence: "AI ‡≤µ‡≤ø‡≤∂‡≥ç‡≤µ‡≤æ‡≤∏:",
                treatmentHeader: "‡≤∂‡≤ø‡≤´‡≤æ‡≤∞‡≤∏‡≥Å ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤¶ ‡≤ö‡≤ø‡≤ï‡≤ø‡≤§‡≥ç‡≤∏‡≤æ ‡≤Ø‡≥ã‡≤ú‡≤®‡≥Ü",
                loginHeader: "‡≤™‡≥ç‡≤≤‡≤æ‡≤Ç‡≤ü‡≥ç ‡≤°‡≤æ‡≤ï‡≥ç‡≤ü‡≤∞‡≥ç AI",
                loginSub: "‡≤™‡≥ç‡≤≤‡≤æ‡≤Ç‡≤ü‡≥ç ‡≤π‡≥Ü‡≤≤‡≥ç‡≤§‡≥ç ‡≤ö‡≥Ü‡≤ï‡≤∞‡≥ç ‡≤¨‡≤≥‡≤∏‡≤≤‡≥Å ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤≤‡≤æ‡≤ó‡≤ø‡≤®‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø.",
                username: "‡≤¨‡≤≥‡≤ï‡≥Ü‡≤¶‡≤æ‡≤∞ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å",
                password: "‡≤ó‡≥Å‡≤™‡≥ç‡≤§‡≤™‡≤¶",
                loginBtn: "‡≤≤‡≤æ‡≤ó‡≤ø‡≤®‡≥ç",
                noAccount: "‡≤ñ‡≤æ‡≤§‡≥Ü ‡≤á‡≤≤‡≥ç‡≤≤‡≤µ‡≥á? <a href='#' id='switch-to-signup' class='text-green-500 hover:underline'>‡≤∏‡≥à‡≤®‡≥ç ‡≤Ö‡≤™‡≥ç</a>",
                signupHeader: "‡≤™‡≥ç‡≤≤‡≤æ‡≤Ç‡≤ü‡≥ç ‡≤°‡≤æ‡≤ï‡≥ç‡≤ü‡≤∞‡≥ç AI",
                signupSub: "‡≤™‡≥ç‡≤≤‡≤æ‡≤Ç‡≤ü‡≥ç ‡≤π‡≥Ü‡≤≤‡≥ç‡≤§‡≥ç ‡≤ö‡≥Ü‡≤ï‡≤∞‡≥ç ‡≤¨‡≤≥‡≤∏‡≤≤‡≥Å ‡≤ñ‡≤æ‡≤§‡≥Ü ‡≤∞‡≤ö‡≤ø‡≤∏‡≤ø.",
                signupBtn: "‡≤∏‡≥à‡≤®‡≥ç ‡≤Ö‡≤™‡≥ç",
                haveAccount: "‡≤à‡≤ó‡≤æ‡≤ó‡≤≤‡≥á ‡≤ñ‡≤æ‡≤§‡≥Ü ‡≤á‡≤¶‡≥Ü‡≤Ø‡≥á? <a href='#' id='switch-to-login' class='text-green-500 hover:underline'>‡≤≤‡≤æ‡≤ó‡≤ø‡≤®‡≥ç</a>",
                logoutBtn: "‡≤≤‡≤æ‡≤ó‡≥å‡≤ü‡≥ç"
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en';
        const LOGGED_USER_KEY = 'plantDoctorLoggedUser';

        function getUsers() {
            return JSON.parse(localStorage.getItem('users') || '[]');
        }

        function saveUsers(users) {
            localStorage.setItem('users', JSON.stringify(users));
        }

        function setLoggedIn(username) {
            localStorage.setItem(LOGGED_USER_KEY, username);
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            setLanguage(currentLang);
        }

        function logout() {
            localStorage.removeItem(LOGGED_USER_KEY);
            document.getElementById('main-section').classList.add('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('signup-form-container').classList.add('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').classList.add('hidden');
            resetApp();
            setLanguage(currentLang);
        }

        // Switch between login and signup
        document.getElementById('switch-to-signup').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form-container').classList.add('hidden');
            document.getElementById('signup-form-container').classList.remove('hidden');
        });

        document.getElementById('switch-to-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('signup-form-container').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
        });

        // Signup handling
        document.getElementById('signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value.trim();

            if (!username || !password) {
                document.getElementById('signup-error').textContent = 'Please enter both username and password.';
                document.getElementById('signup-error').classList.remove('hidden');
                document.getElementById('signup-success').classList.add('hidden');
                return;
            }

            let users = getUsers();
            if (users.some(user => user.username === username)) {
                document.getElementById('signup-error').textContent = 'Username already exists.';
                document.getElementById('signup-error').classList.remove('hidden');
                document.getElementById('signup-success').classList.add('hidden');
                return;
            }

            users.push({ username, password });
            saveUsers(users);

            document.getElementById('signup-error').classList.add('hidden');
            document.getElementById('signup-success').classList.remove('hidden');

            document.getElementById('signup-username').value = '';
            document.getElementById('signup-password').value = '';

            setTimeout(() => {
                document.getElementById('signup-form-container').classList.add('hidden');
                document.getElementById('login-form-container').classList.remove('hidden');
                document.getElementById('signup-success').classList.add('hidden');
            }, 2000);
        });

        // Login handling
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                setLoggedIn(username);
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        // Logout handling
        document.getElementById('logout-button').addEventListener('click', logout);

        // Camera handling
        const useCamera = document.getElementById('use-camera');
        const cameraModal = document.getElementById('camera-modal');
        const video = document.getElementById('video');
        const captureButton = document.getElementById('capture-button');
        const closeCamera = document.getElementById('close-camera');

        useCamera.addEventListener('click', () => {
            cameraModal.classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => {
                    console.error('Error accessing camera:', err);
                    alert('Could not access camera. Please check permissions.');
                    cameraModal.classList.add('hidden');
                });
        });

        captureButton.addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => {
                const file = new File([blob], 'camera_photo.jpg', { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                uploadInput.files = dataTransfer.files;
                handleFileChange({ target: { files: uploadInput.files } });
                cameraModal.classList.add('hidden');
                video.srcObject.getTracks().forEach(track => track.stop());
            }, 'image/jpeg');
        });

        closeCamera.addEventListener('click', () => {
            cameraModal.classList.add('hidden');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });

        // SAME JAVASCRIPT AS BEFORE (API still needs internet)
        const apiKey = "AIzaSyDgcYJ9YCcEmkIpwhpanXKIwO3ymVNYa4g";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;  // Updated to valid model
        
        let uploadedFileBase64 = null;
        const uploadInput = document.getElementById('file-upload');
        const uploadBox = document.getElementById('upload-box');
        const previewSection = document.getElementById('preview-section');
        const resultSection = document.getElementById('result-section');
        const diagnoseButton = document.getElementById('diagnose-button');
        const imagePreview = document.getElementById('image-preview');
        const statusMessage = document.getElementById('status-message');

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function triggerFileUpload() {
            uploadInput.click();
        }

        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                statusMessage.innerHTML = 'File too large. Max size is 5MB. Please choose a smaller image.';
                statusMessage.classList.remove('bg-blue-50');
                statusMessage.classList.add('bg-red-900', 'border-red-700');
                uploadInput.value = '';
                return;
            }
            fileToBase64(file).then(base64Data => {
                uploadedFileBase64 = base64Data;
                imagePreview.src = URL.createObjectURL(file);
                
                document.getElementById('upload-section').classList.add('hidden');
                previewSection.classList.remove('hidden');
                resultSection.classList.add('hidden');
                
                statusMessage.innerHTML = 'Image uploaded successfully. Ready for AI diagnosis (connect to internet to proceed).';
                statusMessage.classList.remove('bg-yellow-900', 'border-yellow-600', 'bg-red-900', 'border-red-700');
                statusMessage.classList.add('bg-blue-900', 'border-blue-700');
                diagnoseButton.disabled = false;
                diagnoseButton.innerHTML = 'Start AI Diagnosis (Needs Internet)';
            }).catch(error => {
                console.error("File processing error:", error);
                statusMessage.innerHTML = 'Could not process file. Check console for details.';
                statusMessage.classList.remove('bg-blue-900');
                statusMessage.classList.add('bg-red-900', 'border-red-700');
            });
        }

        function resetApp() {
            uploadedFileBase64 = null;
            uploadInput.value = '';
            diagnoseButton.disabled = true;
           
            document.getElementById('upload-section').classList.remove('hidden');
            previewSection.classList.add('hidden');
            resultSection.classList.add('hidden');
           
            statusMessage.innerHTML = 'Please upload an image to start the analysis.';
            statusMessage.classList.remove('bg-blue-900', 'border-blue-700', 'bg-red-900', 'border-red-700', 'bg-green-900', 'border-green-700');
            statusMessage.classList.add('bg-yellow-900', 'border-yellow-600');
            document.getElementById('diagnosis-emoji').textContent = 'ü¶†';
        }

        function setLoading(isLoading) {
            diagnoseButton.disabled = isLoading;
            if (isLoading) {
                diagnoseButton.innerHTML = `
                    <div class="loader"></div>
                    Analyzing...
                `;
                statusMessage.innerHTML = 'Sending image to AI for deep analysis... This may take a moment.';
                statusMessage.classList.remove('bg-blue-900', 'border-blue-700');
                statusMessage.classList.add('bg-yellow-900', 'border-yellow-600');
            } else {
                diagnoseButton.innerHTML = 'Start AI Diagnosis (Needs Internet)';
            }
        }

        async function startDiagnosis() {
            if (!uploadedFileBase64) return;
           
            setLoading(true);
           
            // Offline warning if no connection (simple check)
            if (!navigator.onLine) {
                setLoading(false);
                statusMessage.innerHTML = 'No internet connection detected. Diagnosis requires online access to AI.';
                statusMessage.classList.add('bg-red-900', 'border-red-700');
                return;
            }
           
            const systemPrompt = `You are a world-class plant pathologist and agricultural expert. Analyze the provided image of the plant leaf.
            1. Identify the Plant Type (e.g., Tomato, Apple, Corn).
            2. Identify the Disease (or state 'Healthy' if no disease is present).
            3. Provide a detailed Treatment Plan (for disease) or Care Plan (for healthy) in 3-5 concise, actionable steps.
            4. Output ONLY a single JSON object that strictly follows the provided schema. Do not add any extra text or markdown outside the JSON block.`;
            const userQuery = "Analyze this plant leaf image. Identify the plant, the health status, and provide the appropriate care/treatment plan.";
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "plantType": { "type": "STRING" },
                    "diseaseName": { "type": "STRING" },
                    "confidenceScore": { "type": "NUMBER" },
                    "treatmentPlan": { "type": "STRING" }
                },
                required: ["plantType", "diseaseName", "confidenceScore", "treatmentPlan"]
            };
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: uploadInput.files[0].type || "image/jpeg",
                                    data: uploadedFileBase64
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("No response from AI");
                    const responseData = JSON.parse(text);
                    setLoading(false);
                    displayResults(responseData);
                    return;
                } catch (error) {
                    console.error("API Error:", error);
                    if (attempt === maxRetries - 1) {
                        statusMessage.innerHTML = `Diagnosis failed. Error: ${error.message}. Try again later or check connection.`;
                        statusMessage.classList.remove('bg-yellow-900', 'border-yellow-600');
                        statusMessage.classList.add('bg-red-900', 'border-red-700');
                    }
                }
            }
            setLoading(false);
        }
        function displayResults(data) {
            if (!data) return;
            const isHealthy = data.diseaseName.toLowerCase() === 'healthy';
            const confidence = (data.confidenceScore * 100).toFixed(1);
            const emoji = isHealthy ? 'üå±' : '‚ö†Ô∏è';
            document.getElementById('diagnosis-emoji').textContent = emoji;
            document.getElementById('result-diagnosis').textContent = data.diseaseName;
            document.getElementById('result-plant-type').textContent = `Plant Type: ${data.plantType}`;
            document.getElementById('result-confidence').textContent = `${confidence}%`;
            document.getElementById('result-treatment').textContent = data.treatmentPlan;
           
            statusMessage.innerHTML = `Diagnosis complete! Result: <strong>${data.diseaseName}</strong>`;
            statusMessage.className = `text-gray-300 text-base mb-6 p-4 rounded ${isHealthy ? 'bg-green-900 border-l-4 border-green-700' : 'bg-red-900 border-l-4 border-red-700'}`;
            resultSection.classList.remove('hidden');
            const diagnosisCard = document.querySelector('#result-section .grid > div:nth-child(1)');
            const header = document.querySelector('#result-section h2');
            if (isHealthy) {
                diagnosisCard.classList.replace('bg-red-900', 'bg-green-900');
                diagnosisCard.classList.replace('border-red-700', 'border-green-700');
                header.classList.replace('text-red-300', 'text-green-300');
            } else {
                diagnosisCard.classList.replace('bg-green-900', 'bg-red-900');
                diagnosisCard.classList.replace('border-green-700', 'border-red-700');
                header.classList.replace('text-green-300', 'text-red-300');
            }
        }
        // Drag & Drop
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('focus-ring');
        });
        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('focus-ring');
        });
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('focus-ring');
            if (e.dataTransfer.files.length) {
                uploadInput.files = e.dataTransfer.files;
                uploadInput.dispatchEvent(new Event('change'));
            }
        });
        console.log("Plant Doctor AI Loaded! Upload a leaf image to begin (AI needs internet).");
    </script>
</body>
</html>
