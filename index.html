<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Plant Health Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {font-family:system-ui,-apple-system,sans-serif;background:#f7fdee;}
        .card{box-shadow:0 10px 30px rgba(139,172,139,.2);transition:transform .3s,box-shadow .3s;}
        .card:hover{transform:translateY(-2px);box-shadow:0 15px 40px rgba(139,172,139,.3);}
        #upload-box{border:3px dashed #8baf8b;transition:background .2s;cursor:pointer;}
        #upload-box:hover{background:#f0f7f0;}
        .focus-ring{box-shadow:0 0 0 3px rgba(139,172,139,.5);}
        .loader{border:4px solid #f3f3f3;border-top:4px solid #4CAF50;border-radius:50%;width:24px;height:24px;display:inline-block;animation:spin 1s linear infinite;margin-right:.5rem;}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #camera-modal{background:rgba(0,0,0,.8);z-index:50;}
        #video{width:100%;max-width:640px;}
        #sidebar{transition:transform .3s ease-in-out;}
        .history-item{border-bottom:1px solid #ddd;padding:12px 0;}
        .history-item:last-child{border-bottom:none;}
        .history-item h4{font-weight:600;color:#1a5f1a;}
        .history-item p{font-size:0.875rem;color:#555;margin:4px 0;}
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Fixed Top Header -->
    <header class="bg-green-700 text-white py-4 shadow-lg fixed top-0 left-0 right-0 z-40">
        <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
            <!-- Hamburger -->
            <button id="hamburger" class="text-white focus:outline-none">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <!-- App Name Centered -->
            <h1 class="text-2xl md:text-3xl font-bold text-center flex-1">Plant Doctor AI</h1>
            <div class="w-8"></div> <!-- Spacer -->
        </div>
    </header>

    <!-- Sidebar (Hidden by default on mobile) -->
    <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-xl transform -translate-x-full z-50 pt-20 px-6 overflow-y-auto">
        <div class="space-y-4">
            <button id="lang-toggle-sidebar" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">ಕನ್ನಡ</button>
            <button id="history-button" class="w-full bg-teal-600 text-white py-3 rounded-lg font-bold hover:bg-teal-700 transition">History</button>
            <button id="logout-button-sidebar" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition">Logout</button>
        </div>
        <!-- History Panel (inside sidebar) -->
        <div id="history-panel" class="mt-6 hidden">
            <h3 class="text-lg font-semibold text-green-800 mb-3">Recent Scans (3)</h3>
            <div id="history-list" class="space-y-3 text-sm"></div>
            <button id="clear-history" class="mt-4 text-xs text-red-600 underline">Clear History</button>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black opacity-50 hidden z-40"></div>

    <!-- Main Content -->
    <main class="flex-1 pt-20 pb-6 px-4 max-w-7xl mx-auto w-full">

        <!-- Auth Section -->
        <div id="auth-section" class="bg-white rounded-xl card p-6 md:p-10 mt-6">
            <div id="login-form-container">
                <header class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-green-800 mb-2">Plant Doctor AI</h2>
                    <p class="text-lg text-gray-500">Please login to access the plant health checker.</p>
                </header>
                <form id="login-form" class="space-y-4">
                    <div><label for="login-username" class="block text-gray-700 font-semibold mb-2">Username</label>
                        <input type="text" id="login-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500" required></div>
                    <div><label for="login-password" class="block text-gray-700 font-semibold mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500" required></div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition focus-ring">Login</button>
                </form>
                <p class="text-center mt-4">Don't have an account? <a href="#" id="switch-to-signup" class="text-green-600 hover:underline">Sign up</a></p>
                <p id="login-error" class="text-red-600 mt-4 text-center hidden">Invalid username or password. Please try again.</p>
            </div>

            <div id="signup-form-container" class="hidden">
                <header class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-green-800 mb-2">Plant Doctor AI</h2>
                    <p class="text-lg text-gray-500">Create an account to access the plant health checker.</p>
                </header>
                <form id="signup-form" class="space-y-4">
                    <div><label for="signup-username" class="block text-gray-700 font-semibold mb-2">Username</label>
                        <input type="text" id="signup-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500" required></div>
                    <div><label for="signup-password" class="block text-gray-700 font-semibold mb-2">Password</label>
                        <input type="password" id="signup-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500" required></div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition focus-ring">Sign Up</button>
                </form>
                <p class="text-center mt-4">Already have an account? <a href="#" id="switch-to-login" class="text-green-600 hover:underline">Login</a></p>
                <p id="signup-error" class="text-red-600 mt-4 text-center hidden">Username already exists or invalid input.</p>
                <p id="signup-success" class="text-green-600 mt-4 text-center hidden">Account created successfully! Please login.</p>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="main-section" class="hidden bg-white rounded-xl card p-6 md:p-10 mt-6">
            <p class="text-lg text-gray-500 text-center mb-8">Upload a leaf image to get an instant diagnosis and treatment plan.</p>

            <div id="upload-section">
                <div id="upload-box" onclick="triggerFileUpload()" class="flex flex-col items-center justify-center h-48 rounded-lg p-6 text-gray-600 hover:text-green-700 mb-4 border-2 border-dashed border-green-400">
                    <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5-8l-2-2m0 0L7 8m2-2v4"></path></svg>
                    <p class="font-semibold text-lg">Click or Drag & Drop your Plant Leaf Image</p>
                    <p class="text-sm text-gray-400">JPEG, PNG, or GIF up to 5MB</p>
                </div>
                <button id="use-camera" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition focus-ring">Take Photo from Camera</button>
                <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileChange(event)">
            </div>

            <div id="preview-section" class="hidden mt-6 p-4 border border-gray-200 rounded-lg">
                <h2 class="text-xl font-semibold text-green-700 mb-4">Diagnosis Status</h2>
                <div class="md:flex md:space-x-6">
                    <div class="mb-4 md:mb-0 md:w-1/3">
                        <p class="text-gray-500 mb-2">Uploaded Image:</p>
                        <img id="image-preview" class="w-full h-auto object-cover rounded-lg shadow-md" alt="Plant Leaf Preview">
                    </div>
                    <div class="md:w-2/3 flex flex-col justify-between">
                        <div id="status-message" class="text-gray-700 text-base mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">Please upload an image to start the analysis.</div>
                        <button id="diagnose-button" onclick="startDiagnosis()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition focus-ring disabled:opacity-50" disabled>Start AI Diagnosis (Needs Internet)</button>
                        <button id="reset-button" onclick="resetApp()" class="w-full mt-2 bg-gray-300 text-gray-800 py-3 rounded-lg font-bold hover:bg-gray-400 transition focus-ring">Reset</button>
                    </div>
                </div>
            </div>

            <div id="result-section" class="hidden mt-8">
                <h2 class="text-3xl font-bold text-red-600 mb-6 border-b pb-2"><span id="diagnosis-emoji">Warning</span> Diagnosis Result</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                        <h3 class="text-xl font-semibold text-red-700 mb-3">Identified Issue:</h3>
                        <p id="result-diagnosis" class="text-2xl font-extrabold text-red-800"></p>
                        <p id="result-plant-type" class="text-gray-600 mt-1"></p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                        <h3 class="text-xl font-semibold text-green-700 mb-3">AI Confidence:</h3>
                        <p id="result-confidence" class="text-2xl font-extrabold text-green-800"></p>
                    </div>
                </div>
                <div class="mt-6 bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                    <h3 class="text-2xl font-bold text-green-800 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.204A9.954 9.954 0 0012 3c-4.419 0-8.24 1.803-10.618 4.796m14.236 0c.2.469.366.97.485 1.504M20 10.5c0 .324.015.645.044.966M12 21c-2.41 0-4.63-.642-6.556-1.754M17.152 14.848l-1.424-1.424m-1.424-1.424l-1.424-1.424"></path></svg>
                        Recommended Treatment Plan
                    </h3>
                    <p id="result-treatment" class="text-gray-700 whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-80">
        <div class="bg-white p-4 rounded-lg shadow-lg max-w-lg w-full">
            <video id="video" autoplay playsinline class="w-full"></video>
            <div class="mt-4 flex justify-between">
                <button id="capture-button" class="bg-green-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-700">Capture</button>
                <button id="close-camera" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-700">Close</button>
            </div>
        </div>
    </div>

    <script>
        /* ----------  LANGUAGE & PERSISTENT LOGIN ---------- */
        const translations = { /* ... same as before ... */ };
        let currentLang = localStorage.getItem('lang') || 'en';
        const LOGGED_USER_KEY = 'plantDoctorLoggedUser';

        function getUsers(){return JSON.parse(localStorage.getItem('users')||'[]');}
        function saveUsers(u){localStorage.setItem('users',JSON.stringify(u));}
        function setLoggedIn(username){
            localStorage.setItem(LOGGED_USER_KEY,username);
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            setLanguage(currentLang);
        }
        function logout(){
            localStorage.removeItem(LOGGED_USER_KEY);
            document.getElementById('main-section').classList.add('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('signup-form-container').classList.add('hidden');
            document.getElementById('login-username').value=''; document.getElementById('login-password').value='';
            document.getElementById('login-error').classList.add('hidden');
            resetApp(); setLanguage(currentLang);
        }

        // Check login on load
        window.addEventListener('load',()=>{
            const savedUser = localStorage.getItem(LOGGED_USER_KEY);
            if(savedUser && getUsers().some(u=>u.username===savedUser)){
                setLoggedIn(savedUser);
            }else{
                setLanguage(currentLang);
            }
            updateLangButton();
            loadHistory();
        });

        /* ----------  SIDEBAR & HISTORY ---------- */
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const hamburger = document.getElementById('hamburger');
        const historyBtn = document.getElementById('history-button');
        const historyPanel = document.getElementById('history-panel');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history');

        function toggleSidebar(open){
            sidebar.classList.toggle('-translate-x-full', !open);
            overlay.classList.toggle('hidden', !open);
        }
        hamburger.addEventListener('click', ()=>toggleSidebar(true));
        overlay.addEventListener('click', ()=>toggleSidebar(false));

        historyBtn.addEventListener('click', ()=>{
            historyPanel.classList.toggle('hidden');
        });

        clearHistoryBtn.addEventListener('click', ()=>{
            sessionStorage.removeItem('scanHistory');
            loadHistory();
        });

        function saveToHistory(result){
            let history = JSON.parse(sessionStorage.getItem('scanHistory') || '[]');
            history.unshift({
                timestamp: new Date().toLocaleString('en-IN'),
                plant: result.plantType,
                disease: result.diseaseName,
                confidence: (result.confidenceScore * 100).toFixed(1) + '%'
            });
            sessionStorage.setItem('scanHistory', JSON.stringify(history.slice(0, 3)));
            loadHistory();
        }

        function loadHistory(){
            const history = JSON.parse(sessionStorage.getItem('scanHistory') || '[]');
            if(history.length === 0){
                historyList.innerHTML = '<p class="text-gray-500 text-sm">No scans yet.</p>';
                return;
            }
            historyList.innerHTML = history.map(item => `
                <div class="history-item">
                    <h4>${item.disease} (${item.plant})</h4>
                    <p><strong>Confidence:</strong> ${item.confidence}</p>
                    <p class="text-xs text-gray-400">${item.timestamp}</p>
                </div>
            `).join('');
        }

        /* ----------  LANGUAGE ---------- */
        function updateLangButton(){
            const btn = document.getElementById('lang-toggle-sidebar');
            btn.textContent = currentLang === 'en' ? 'ಕನ್ನಡ' : 'English';
        }
        function setLanguage(lang){
            if(lang===currentLang) return;
            currentLang=lang; localStorage.setItem('lang',lang);
            const t=translations[lang];
            document.querySelector('#main-section p.text-lg').textContent=t.subtitle;
            document.querySelector('#upload-box p.font-semibold').textContent=t.uploadBox;
            document.querySelector('#upload-box p.text-sm').textContent=t.uploadHint;
            document.getElementById('use-camera').textContent=t.cameraBtn;
            document.querySelector('#preview-section h2').textContent=t.diagnosisStatus;
            document.querySelector('#preview-section p.text-gray-500').textContent=t.uploadedImage;
            document.getElementById('diagnose-button').textContent=t.diagnoseBtn;
            document.getElementById('reset-button').textContent=t.resetBtn;
            document.querySelector('#result-section h2').innerHTML=`<span id="diagnosis-emoji">Warning</span> ${t.resultHeader}`;
            document.querySelector('#result-section .bg-red-50 h3').textContent=t.identifiedIssue;
            document.querySelector('#result-section .bg-green-50 h3').textContent=t.confidence;
            document.querySelector('#result-section h3.text-2xl').textContent=t.treatmentHeader;
            updateLangButton();
        }
        document.getElementById('lang-toggle-sidebar').addEventListener('click',()=>setLanguage(currentLang==='en'?'kn':'en'));
        document.getElementById('logout-button-sidebar').addEventListener('click',logout);

        /* ----------  AUTH & CAMERA (unchanged) ---------- */
        // ... [Login, Signup, Camera logic same as before] ...

        /* ----------  AI DIAGNOSIS ---------- */
        const apiKey="AIzaSyDgcYJ9YCcEmkIpwhpanXKIwO3ymVNYa4g";
        const API_URL=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        let uploadedFileBase64=null;
        const uploadInput=document.getElementById('file-upload'),uploadBox=document.getElementById('upload-box'),previewSection=document.getElementById('preview-section'),resultSection=document.getElementById('result-section'),diagnoseButton=document.getElementById('diagnose-button'),imagePreview=document.getElementById('image-preview'),statusMessage=document.getElementById('status-message');

        function fileToBase64(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(f);});}
        function triggerFileUpload(){uploadInput.click();}
        function handleFileChange(e){
            const file=e.target.files[0]; if(!file) return;
            if(file.size>5*1024*1024){
                statusMessage.innerHTML=currentLang==='en'?'File too large. Max 5 MB.':'ಫೈಲ್ ತುಂಬಾ ದೊಡ್ಡದಾಗಿದೆ. ಗರಿಷ್ಠ 5 MB.';
                statusMessage.className='text-gray-700 text-base mb-4 bg-red-50 border-l-4 border-red-400 p-3 rounded';uploadInput.value='';return;
            }
            fileToBase64(file).then(b=>{uploadedFileBase64=b;imagePreview.src=URL.createObjectURL(file);
                document.getElementById('upload-section').classList.add('hidden');previewSection.classList.remove('hidden');resultSection.classList.add('hidden');
                statusMessage.innerHTML=translations[currentLang].readyMsg;
                statusMessage.className='text-gray-700 text-base mb-4 bg-blue-50 border-l-4 border-blue-400 p-3 rounded';
                diagnoseButton.disabled=false;diagnoseButton.innerHTML=translations[currentLang].diagnoseBtn;
            });
        }
        function resetApp(){
            uploadedFileBase64=null;uploadInput.value='';diagnoseButton.disabled=true;
            document.getElementById('upload-section').classList.remove('hidden');previewSection.classList.add('hidden');resultSection.classList.add('hidden');
            statusMessage.innerHTML=translations[currentLang].readyMsg;
            statusMessage.className='text-gray-700 text-base mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded';
            document.getElementById('diagnosis-emoji').textContent='Warning';
        }
        function setLoading(l){
            diagnoseButton.disabled=l;
            if(l){diagnoseButton.innerHTML=`<div class="loader"></div>${currentLang==='en'?'Analyzing...':'ವಿಶ್ಲೇಷಿಸಲಾಗುತ್ತಿದೆ...'}`;
                statusMessage.innerHTML=translations[currentLang].analyzingMsg;
                statusMessage.className='text-gray-700 text-base mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded';
            }else{diagnoseButton.innerHTML=translations[currentLang].diagnoseBtn;}
        }
        async function startDiagnosis(){
            if(!uploadedFileBase64) return; setLoading(true);
            if(!navigator.onLine){setLoading(false);statusMessage.innerHTML=translations[currentLang].noInternet;statusMessage.className='text-gray-700 text-base mb-4 bg-red-50 border-l-4 border-red-400 p-3 rounded';return;}
            const systemPrompt=`You are a world-class plant pathologist...`; // [same as before]
            const payload={ /* ... same payload ... */ };
            try{
                const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
                if(!r.ok) throw new Error(`HTTP ${r.status}`);
                const j=await r.json(); const txt=j.candidates?.[0]?.content?.parts?.[0]?.text;
                if(!txt) throw new Error("No AI response");
                const data=JSON.parse(txt); setLoading(false); displayResults(data);
                saveToHistory(data); // Save to history
            }catch(err){
                setLoading(false);
                statusMessage.innerHTML=`${currentLang==='en'?'Diagnosis failed:':'ರೋಗನಿರ್ಣಯ ವಿಫಲ:'} ${err.message}`;
                statusMessage.className='text-gray-700 text-base mb-4 bg-red-50 border-l-4 border-red-400 p-3 rounded';
            }
        }
        function displayResults(d){ /* ... same as before ... */ }

        // Drag & Drop
        uploadBox.addEventListener('dragover',e=>{e.preventDefault();uploadBox.classList.add('focus-ring');});
        uploadBox.addEventListener('dragleave',()=>uploadBox.classList.remove('focus-ring'));
        uploadBox.addEventListener('drop',e=>{e.preventDefault();uploadBox.classList.remove('focus-ring');
            if(e.dataTransfer.files.length){uploadInput.files=e.dataTransfer.files;uploadInput.dispatchEvent(new Event('change'));}});

        setLanguage(currentLang);
        console.log("Plant Doctor AI with Sidebar & History Ready!");
    </script>
</body>
</html>
